<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
  <script type="text/javascript">
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'UA-xxxxxx-xx');
  </script>
  

  <!-- Baidu Tongji -->
  
  <script type="text/javascript">
    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
  

  <!-- Baidu Push -->
  
  <script>
    (function() {
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>
  

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc" />
  <meta name="baidu-site-verification" content="PpzM9WxOJU" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="It&#39;s an IT blog..." />
  <meta name="keyword" content="v-vincen,v-vincen,livemylife,IT  blog,Blog" />
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg" />

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>
  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/beantech.min.css" />

  <!-- Pygments Highlight CSS -->
  
<link rel="stylesheet" href="../../../../css/highlight.css">
<link rel="stylesheet" href="../../../../css/widget.css">
<link rel="stylesheet" href="../../../../css/rocket.css">
<link rel="stylesheet" href="../../../../css/signature.css">
<link rel="stylesheet" href="../../../../css/catalog.css">
<link rel="stylesheet" href="../../../../css/livemylife.css">


  
  <!-- wave start -->
  <link rel="stylesheet" href="/css/wave.css" />
  <!-- wave end -->
  

  
  <!-- top start (article top hot config) -->
  <link rel="stylesheet" href="/css/top.css" />
  <!-- top end -->
  

  
  <!-- ThemeColor start -->
  <link rel="stylesheet" href="/css/scroll.css" />
  <!-- ThemeColor end -->
  

  
  <!-- viewer start (Picture preview) -->
  <link rel="stylesheet" href="/css/viewer.min.css" />
  <!-- viewer end -->
  

  
  <!-- Search start -->
  <link rel="stylesheet" href="/css/search.css" />
  <!-- Search end -->
  

  
  <!-- ThemeColor start -->
  <link rel="stylesheet" href="/css/themecolor.css" />
  <!-- ThemeColor end -->
  

  

  
  <!-- gitalk start -->
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
  <link rel="stylesheet" href="/css/gitalk.css" />
  <!-- gitalk end -->
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
    href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://yoursite-url/2020/12/02/Redis分布式锁原理看这篇就够了-循循渐进/">
  <title>
    
    Redis分布式锁原理看这篇就够了, 循循渐进 - 马称博客
    
  </title>
<meta name="generator" content="Hexo 4.2.1"></head>


<!-- hack iOS CSS :active style -->

<body ontouchstart="" class="body--home">
	<!-- ThemeColor -->
	
	<!-- ThemeColor -->
<!-- <div class="toggle" onclick="document.body.classList.toggle('body--dark')">Switch Color</div> -->

<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons bright-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>

	

	<!-- Gitter -->
	
	<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

	

	<!-- Navigation (contains search)-->
	<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Live My Life</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">Home</a>
          </li>

          

          
          

          
          <li>
            <a href="/categories/">Categories</a>
          </li>
          
          

          
          <li>
            <a href="/about/">About</a>
          </li>
          
          

          
          <li>
            <a href="/archive/">Archives</a>
          </li>
          
          

          
          <li>
            <a href="/tags/">Tags</a>
          </li>
          
          

          
          <li><a class="popup-trigger" title="Search"><span class="search-icon"></span>Search</a></li>
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>


<script>
  // Drop Bootstarp low-performance Navbar
  // Use customize navbar with high-quality material design animation
  // in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


	<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    header.intro-header {
       /*post*/
        background-image: url('/img/header_img/categories_bg.jpg');
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/vincent-white.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#Redis" title="Redis">Redis</a>
              
              <a class="tag" href="/tags/#分布式锁" title="分布式锁">分布式锁</a>
              
            </div>
            <h1>Redis分布式锁原理看这篇就够了, 循循渐进</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by 马称博客 on
              2020-12-02
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">10</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">3.1k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- 不蒜子统计 start -->
            <span class="meta">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            <!-- WordCount end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



	<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
	<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/23616e6031a54317874149941fc5f2b7~tplv-k3u1fbpfcp-watermark.image" alt=""></p>
<p>年轻的时候，爱上什么都不为过。成熟了以后，放弃什么都能理解；每个人终其一生都在寻找，那个和自己灵魂相近的人  – 莫言</p>
<blockquote>
<p>人若无名，专心练剑。作者麻花，帝都一枚普普通通程序员，文章原创自公众号 <strong>源码兴趣圈</strong></p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>分布式锁相信大家一定不会陌生, 想要用好或者自己写一个却没那么简单</p>
<p>想要达到上述的条件, 一定要 <strong>掌握分布式锁的应用场景</strong>, 以及分布式锁的不同实现, 不同实现之间有什么区别</p>
<h2 id="分布式锁场景"><a href="#分布式锁场景" class="headerlink" title="分布式锁场景"></a>分布式锁场景</h2><p>如果想真正了解分布式锁, 需要结合一定场景; 举个例子, 某夕夕上抢购 AirPods Pro 的 100 元优惠券</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c011cbd8bb8f4e468f5568b87e797a60~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>如果使用下面这段代码当作抢购优惠券的后台程序, 我们一起看一下, 可能存在什么样的问题</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6a3d615812d040d9b8248666fda842a5~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>很明显的就是这段流程在并发场景下并不安全, 会导致优惠券发放超过预期, 类似电商抢购超卖问题</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/138b6852e09d4daabb79e577433dc4a7~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>想一哈有什么方式可以避免这种分布式下超量问题?</p>
<p><strong>互斥加锁</strong>, Java 中互斥锁的语义就是 <strong>同一时间, 只允许一个客户端对资源进行操作</strong></p>
<p>比如 Java 中的关键字 <strong>Synchronized</strong>, 以及 JUC Lock 包下的 ReentrantLock 都可以实现互斥锁</p>
<h3 id="JVM-锁"><a href="#JVM-锁" class="headerlink" title="JVM 锁"></a>JVM 锁</h3><p>如图所示, 加入 JVM synchronized 锁确实可以解决单机下并发问题</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c0f899454aaf4a37a914f2a3b94928ec~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>但是生产环境为了保证服务高可用, 起码要 <strong>部署两台服务</strong>, 这样的话 synchronized 就不起作用了, 因为它的 <strong>作用域只是单个 JVM</strong></p>
<p>分布式情况下只能通过 <strong>分布式锁</strong> 来解决多个服务资源共享的问题了</p>
<blockquote>
<p>如果死磕单服务, 那没的说, 分布式锁就是浮云 ☁️</p>
</blockquote>
<h2 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h2><p>分布式锁的定义:</p>
<blockquote>
<p><strong>保证同一时间只能有一个客户端对共享资源进行操作</strong></p>
</blockquote>
<p>比对刚才举的例子, 不论部署多少台优惠券服务, 只会有 <strong>一台服务能够对优惠券数量进行增删操作</strong></p>
<p>另外有几点要求也是必须要满足的: </p>
<p>1、<strong>不会发生死锁。</strong> 即使有一个客户端在持有锁的期间崩溃而没有主动解锁，也能保证后续其他客户端能加锁</p>
<p>2、<strong>具有容错性。</strong> 只要大部分的Redis节点正常运行，客户端就可以加锁和解锁</p>
<p>3、<strong>解铃还须系铃人。</strong> 加锁和解锁必须是同一个客户端，客户端自己不能把别人加的锁给解了</p>
<p>分布式锁实现大致分为三种, Redis、Zookeeper、数据库, 文章以 Redis 展开分布式锁的讨论</p>
<h2 id="分布式锁演进史"><a href="#分布式锁演进史" class="headerlink" title="分布式锁演进史"></a>分布式锁演进史</h2><p>先来构思下分布式锁实现思路</p>
<p>首先我们必须保证同一时间只有一个客户端(部署的优惠券服务)操作数量加减</p>
<p>其次本次 <strong>客户端操作完成后</strong>, 需要让 <strong>其它客户端继续执行</strong></p>
<p>1、客户端一存放一个标志位, 如果添加成功, 操作减优惠券数量操作</p>
<p>2、客户端二添加标志位失败, 本次减库存操作失败(或继续尝试获取等)</p>
<p>3、客户端一优惠券操作完成后, 需要将标志位释放, 以便其余客户端对库存进行操作</p>
<h3 id="第一版-setnx"><a href="#第一版-setnx" class="headerlink" title="第一版 setnx"></a>第一版 setnx</h3><p>向 Redis 中添加一个 lockKey 锁标志位, 如果添加成功则能够继续向下执行扣减优惠券数量操作, 最后再释放此标志位</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7f5f89c2151948c6ba9f88fd75a0d655~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>由于使用的是 Spring 提供的 Redis 封装的 Start 包, 所有有些命令与 Redis 原生命令不相符</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setIfAbsent(key, val) -&gt; setnx(key, val)</span><br></pre></td></tr></table></figure>



<p>加了简单的几行代码, 一个简单的分布式锁的雏形就出来了</p>
<h3 id="第二版-expire"><a href="#第二版-expire" class="headerlink" title="第二版 expire"></a>第二版 expire</h3><p>上面第一版基于 setnx 命令实现分布式锁的缺陷也是很明显的, 那就是 <strong>一定情况下可能发生死锁</strong></p>
<p>画个图, 举个例子说明哈</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d4bfa384a59d4200811880243e73b154~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>上图说明, 线程1在成功获取锁后, 执行流程时异常结束, <strong>没有执行释放锁操作</strong>, 这样就会 <strong>产生死锁</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8c7506b17b1c43fe8ba56841e3f958be~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>如果方法执行异常导致的线程被回收, 那么可以将解锁操作放到 finally 块中</p>
<p>但是还有存在死锁问题, <strong>如果获得锁的线程在执行中, 服务被强制停止或服务器宕机, 锁依然不会得到释放</strong></p>
<p>这种极端情况下我们还是要考虑的, 毕竟不能只想着服务没问题对吧</p>
<p>对 Redis 的 <strong>锁标志位加上过期时间</strong> 就能很好的防止死锁问题, 继续更改下程序代码</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5423e97ef61d43098e3c41cec6b0581d~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>虽然 <strong>小红旗处</strong> 对分布式锁添加了过期时间, 但依然无法避免极端情况下的死锁问题</p>
<p><strong>那就是如果在客户端加锁成功后, 还没有设置过期时间时宕机</strong></p>
<p>如果想要避免添加锁时死锁, 那就对添加锁标志位 &amp; 添加过期时间命令 <strong>保证一个原子性, 要么一起成功, 要么一起失败</strong></p>
<h3 id="第三版-set"><a href="#第三版-set" class="headerlink" title="第三版 set"></a>第三版 set</h3><p>我们的添加锁原子命令就要登场了, 从 Redis 2.6.12 版本起, 提供了可选的 <strong>字符串 set 复合命令</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET key value [expiration EX seconds|PX milliseconds] [NX|XX]</span><br></pre></td></tr></table></figure>

<p>可选参数如下:</p>
<ul>
<li><strong>EX:</strong> 设置超时时间，单位是秒</li>
<li><strong>PX:</strong> 设置超时时间，单位是毫秒</li>
<li><strong>NX:</strong> IF NOT EXIST 的缩写，只有 <strong>KEY不存在的前提下</strong> 才会设置值</li>
<li><strong>XX:</strong> IF EXIST 的缩写，只有在 <strong>KEY存在的前提下</strong> 才会设置值</li>
</ul>
<p>继续完善分布式锁的应用程序, 代码如下:</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/709210e5510a41b1a11f729100f103d1~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>我使用的 <strong>2.0.9.RELEASE</strong> 版本的 SpringBoot, RedisTemplate 中不支持 set 复合命令, 所以临时换个 Jedis 来实现</p>
<p><strong>加锁以及设置过期时间确实保证了原子性, 但是这样的分布式锁就没有问题了么?</strong></p>
<p>我们根据图片以及流程描述设想一下这个场景</p>
<p>1、线程一获取锁成功, 设置过期时间五秒, 接着执行业务逻辑</p>
<p>2、接着线程一获取锁后执行业务流程, 执行的时间超过了过期时间, 锁标志位过期进行释放, 此时线程二获取锁成功</p>
<p>3、然鹅此时线程一执行完业务后, 开始执行释放锁的流程, 然后顺手就把线程二获取的锁释放了</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f7e27f2ab2ba44fca5cd5754320809a1~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>如果线上真的发生上述问题, 那真的是xxx, 更甚者可能存在线程一将线程二的锁释放掉之后, 线程三获取到锁, 然后线程二执行完将线程三的锁释放</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a469201159a6409483e822d9db425ea4~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<h3 id="第四版-verify-value"><a href="#第四版-verify-value" class="headerlink" title="第四版 verify value"></a>第四版 verify value</h3><p>事当如今, 只能创建辨别客户端身份的唯一值了, 将加锁及解锁归一化, 上代码~</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e5db1ec30894fdc88a991cf94cce8f5~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>这一版的代码相当于我们添加锁标志位时, 同时为每个客户端设置了 uuid 作为锁标志位的 val, 解锁时需要判断锁的 val 是否和自己客户端的相同, 辨别成功才会释放锁</p>
<p>但是上述代码执行业务逻辑如果抛出异常, 锁只能等待过期时间, 我们可以将解锁操作放到 finally 块</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b37507cd5d3d4c4fbdd19920406460e5~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>大眼一看, 上上下下实现了四版分布式锁, 也该没问题了吧</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cf96127a4aa24bf49e14587012d60a1e~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>真相就是: 解锁时,  <strong>由于判断锁和删除标志位并不是原子性的, 所以可能还是会存在误删</strong></p>
<p>1、线程一获取锁后, 执行流程balabala… 判断锁也是自家的, 这时 CPU 转头去做别的事情了, 恰巧线程一的锁过期时间到了</p>
<p>2、线程二此时顺理成章的获取到了分布式锁, 执行业务逻辑balabala…</p>
<p>3、线程一再次分配到时间片继续执行删除操作</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4007b69dd61b4a6bab6e7537f1e9636b~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>解决这种非原子操作的方式只能 <strong>将判断元素值和删除标志位当作一个原子操作</strong></p>
<h3 id="第五版-lua"><a href="#第五版-lua" class="headerlink" title="第五版 lua"></a>第五版 lua</h3><p>很不友好的是, del 删除操作并没有提供原子命令, 所以我们需要想点办法</p>
<p>Redis在 2.6 推出了脚本功能, 允许开发者使用 Lua 语言编写脚本传到 Redis 中执行</p>
<p>使用 Lua 脚本有什么好处呢?</p>
<p><strong>1、减少网络开销</strong></p>
<p>原本我们需要向 Redis 服务请求多次命令, 可以将命令写在 Lua 脚本中, 这样执行只会发起一次网络请求</p>
<p><strong>2、原子操作</strong></p>
<p>Redis 会将 Lua 脚本中的命令当作一个整体执行, 中间不会插入其它命令</p>
<p><strong>3、复用(大家自己探索哈)</strong></p>
<p>客户端发送的脚步会存储 Redis 中, 其他客户端可以复用这一脚本而不需要使用代码完成相同的逻辑</p>
<p>那我们编写一个简单的 Lua 脚本实现原子删除操作</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/df9fac1878b547779f58f87b9d06e6c4~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>重点就在 Lua 脚本这一块, 重点说一下这块的逻辑</p>
<p>script 脚本就是我们在 Redis 中执行的 Lua 脚本, 后面跟的两个 List 分别是 KEYS、ARGV</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cache.eval(script, Lists.newArrayList(lockKey), Lists.newArrayList(lockValue));</span><br></pre></td></tr></table></figure>



<p><strong>KEYS[1]:</strong> lockKey</p>
<p><strong>ARGV[1]:</strong> lockValue</p>
<p>代码不是很多, 也比较简单, 就是在 Java 中代码实现的逻辑放到了一个 Lua 脚本中</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 获取 KEYS[<span class="number">1</span>] 对应的 Val</span><br><span class="line"><span class="keyword">local</span> cliVal = redis.call(<span class="string">'get'</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"># 判断 KEYS[<span class="number">1</span>] 与 ARGV[<span class="number">1</span>] 是否保持一致</span><br><span class="line"><span class="keyword">if</span>(cliVal == ARGV[<span class="number">1</span>]) <span class="keyword">then</span> </span><br><span class="line">  # 删除 KEYS[<span class="number">1</span>]</span><br><span class="line">  redis.call(<span class="string">'del'</span>, KEYS[<span class="number">1</span>]) </span><br><span class="line">  <span class="keyword">return</span> <span class="string">'OK'</span> </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span> </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<p>到了这种程度, 已经可以放到一些并发量不大的项目中生产使用了</p>
<h2 id="TODO-列表"><a href="#TODO-列表" class="headerlink" title="TODO 列表"></a>TODO 列表</h2><p>虽然上述代码已经很大程度上解决了分布式锁可能存在的一些问题</p>
<p>但是下述列出的问题部分就不是客户端代码范畴内的事情了</p>
<ul>
<li><p>如何实现可重入锁</p>
</li>
<li><p>如何解决代码执行锁超时</p>
</li>
<li><p>主从节点同步数据丢失导致锁丢失问题</p>
</li>
</ul>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1bb999cd956242bca19eea51e13dd366~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p>
<p>上述问题等下一篇介绍 Redisson 源码时会一一说明, 顺道向大家推出一款 <strong>Redis 官方推荐的客户端: Redisson</strong></p>
<p>Jedis… 等客户端平常使用是绰绰有余的, 但是在功能上还是和 Redisoon 比不了</p>
<blockquote>
<p>并不是推荐一定要用 Redisson, 根据不同场景选用不同客户端</p>
</blockquote>
<p>Redisson 就是为分布式提供 <strong>各种不同锁以及多样化的技术支持,</strong> 感兴趣的小伙伴可以看一下 Giuhub 上的介绍, 挺详细的</p>
<p>下一篇文章会详细介绍 Redisson 分布式锁的加锁、解锁原理</p>
<blockquote>
<p>看了 Redisson 的源码后简直了… 然后对之前项目的分布式锁做了重构, 在原有基础上增加了如下功能</p>
</blockquote>
<ul>
<li><strong>保证了加锁、解锁之间的原子性</strong></li>
<li><strong>可重入的分布式锁</strong></li>
<li><strong>分布式锁自动延期功能</strong></li>
</ul>
<h2 id="文末总结"><a href="#文末总结" class="headerlink" title="文末总结"></a>文末总结</h2><p>本篇文章从最简单的分布式锁说起, 一步一步的讲述存在的问题以及解决方式, 最终得到个基本可用的分布式锁</p>
<p>但是事无绝对, 对于分布式锁的应用, 还是推荐在 <strong>代码以及数据库表中添加兜底策略, 乐观锁等措施</strong></p>
<p>另外向大家推荐了一款功能强大的 Redis 客户端, 感兴趣的小伙伴可以引入试下 😊</p>
<p>由于作者水平有限, 欢迎大家能够反馈指正文章中错误不正确的地方, 感谢 🙏</p>
<p>小伙伴的喜欢就是对我最大的支持, 如果读了文章有所收获, 希望能够 <strong>点赞、评论、关注三连!</strong></p>
<p><strong>推荐阅读：</strong></p>
<ul>
<li><a href="https://juejin.cn/post/6896645994012737544" target="_blank" rel="noopener">短文 | 如何解决 JDK 线程池不超过最大线程数下快速消费任务</a></li>
<li><a href="https://juejin.cn/post/6896278031317663751" target="_blank" rel="noopener">万字图文 | 聊一聊 ReentrantLock 和 AQS 那点事（看完不会你找我）</a></li>
<li><a href="https://juejin.cn/post/6891814155960107015" target="_blank" rel="noopener">如何处理 JDK 线程池内线程执行异常?</a></li>
<li><a href="https://juejin.cn/post/6891120931716988942" target="_blank" rel="noopener">谨慎使用 Java8 新特性 parallelStream</a></li>
</ul>
<p><font size='3' color='#009999'><em>作者麻花，坐标帝都 Java 后端研发，励志成为架构师的一枚处女座程序员，专注高并发、框架底层源码、分布式等知识分享</em></font></p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          
          <li class="next">
            <a href="/2020/12/02/年轻人-看看Redisson是如何实现分布式锁/" data-toggle="tooltip" data-placement="top" title="年轻人,看看Redisson是如何实现分布式锁">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <div class="tip">
          <p>
            If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
          </p>
        </div>
        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=Redis分布式锁原理看这篇就够了, 循循渐进&body=Hi,I found this website and thought you might like it http://yoursite-url/2020/12/02/Redis分布式锁原理看这篇就够了-循循渐进/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

<!-- gitalk start -->
<!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

<div id="gitalk-container"></div>

<!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
<script src="/js/comment/gitalk.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: '',
    clientSecret: '',
    repo: '',
    owner: '',
    admin: '',
    id: 'Wed Dec 02 2020 23:25:37 GMT+0800', // Ensure uniqueness and length less than 50
    distractionFreeMode: false, // Facebook-like distraction free mode
    perPage: 10 ,
    pagerDirection: 'last',
    createIssueManually: false ,
    language: 'en'
  });
  gitalk.render('gitalk-container');

  var gtFolded = () => {
    setTimeout(function() {
      let markdownBody = document.getElementsByClassName("markdown-body");
      let list = Array.from(markdownBody);
      list.forEach(item => {
        if (item.clientHeight > 250) {
          item.classList.add('gt-comment-body-folded');
          item.style.maxHeight = '250px';
          item.title = 'Click to Expand';
          item.onclick = function() {
            item.classList.remove('gt-comment-body-folded');
            item.style.maxHeight = '';
            item.title = '';
            item.onclick = null;
          };
        }
      })
    }, 800);
  }
</script>

<!-- gitalk end -->



<!-- 2. gitment comment -->



<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#前言"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">前言</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#分布式锁场景"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">分布式锁场景</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#JVM-锁"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">JVM 锁</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#分布式锁"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">分布式锁</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#分布式锁演进史"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">分布式锁演进史</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#第一版-setnx"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">第一版 setnx</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#第二版-expire"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">第二版 expire</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#第三版-set"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">第三版 set</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#第四版-verify-value"><span class="toc-nav-number">4.4.</span> <span class="toc-nav-text">第四版 verify value</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#第五版-lua"><span class="toc-nav-number">4.5.</span> <span class="toc-nav-text">第五版 lua</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#TODO-列表"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">TODO 列表</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#文末总结"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">文末总结</span></a></li></ol>
        
        </div>
      </aside>
    


      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#Redis" title="Redis">Redis</a>
            
            <a class="tag" href="/tags/#分布式锁" title="分布式锁">分布式锁</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
          <li>
            <a href="" target="_blank">友链1</a>
          </li>
          
          <li>
            <a href="" target="_blank">友链2</a>
          </li>
          
          <li>
            <a href="" target="_blank">友链3</a>
          </li>
          
          <li>
            <a href="" target="_blank">友链4</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



	<!-- Footer (contains ThemeColor、viewer) -->
	<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          

          
          <li>
            <a target="_blank" href="https://blog.csdn.net/qq_37781649">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-copyright fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          

          

          
          <li>
            <a target="_blank" href="https://juejin.cn/user/835284568143799">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-gg fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          

          

          
          <li>
            <a target="_blank" href="https://segmentfault.com/u/moon_5fc7bedc3d717">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-sun-o fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          

          

          
          <li>
            <a target="_blank" href="https://www.zhihu.com/people/always-48-99">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa  fa-stack-1x fa-inverse">知</i>
              </span>
            </a>
          </li>
          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          马称博客
          2020 All Rights Reserved. Designed by Hexo.
          <br>
          <!-- Theme by
          <a href="https://v-vincen.life/" target="_blank" rel="noopener">v-vincen.life</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a href="https://v-vincen.life/" target="_blank" rel="noopener">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px"
            src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe> -->

        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>

<!-- jQuery -->
<script type="text/javascript" src="/js/jquery.min.js"></script>
<!-- <script type="text/javascript" src="/js/jquery.js"></script> -->
<!-- <script type="text/javascript" src="//cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->

<!-- Bootstrap Core JavaScript -->
<script type="text/javascript" src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script type="text/javascript" src="/js/hux-blog.min.js"></script>

<!-- catalog -->
<script type="text/javascript" async="true" src="/js/catalog.js?v=1.0.0"></script>

<!-- totop(rocket) -->
<script type="text/javascript" async="true" src="/js/totop.js?v=1.0.0"></script>

<!-- Busuanzi JavaScript -->
<script type="text/javascript" async="true" src="/js/busuanzi.pure.mini.js"></script>


<!-- Scroll start -->
<script type="text/javascript" src="/js/scroll.js"></script>
<!-- Scroll end -->



<!-- ThemeColor start -->
<script type="text/javascript" src="/js/themecolor.js"></script>
<!-- ThemeColor end -->





<!-- viewer start -->
<!-- viewer start (Picture preview) -->
<script type="text/javascript" src="/js/viewer/viewer.min.js"></script>
<script type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
<!-- viewer end -->


<script>
  // async load function
  function async(u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
  }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){ hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if($('#tag_cloud').length !== 0){ async("http://yoursite-url/js/jquery.tagcloud.js",function(){ $.fn.tagcloud.defaults = { //size: {start: 1, end: 1, unit: 'em'}, color: {start:
'#bbbbee', end: '#0085a1'}, }; $('#tag_cloud a').tagcloud(); }) } </script> -->

	<!-- Search -->
	
	<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="Search..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  <script src="/js/ziploader.js"></script>
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;

            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


	

	<!-- Image to hack wechat -->
	<!-- <img src="http://yoursite-url/img/icon_wechat.png" width="0" height="0" /> -->
	<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
